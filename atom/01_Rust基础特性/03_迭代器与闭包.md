# è¿­ä»£å™¨ä¸é—­åŒ…

## ã€30å­—æ ¸å¿ƒã€‘

**è¿­ä»£å™¨æ˜¯æƒ°æ€§æ±‚å€¼çš„æ•°æ®éå†æŠ½è±¡ï¼Œé—­åŒ…æ˜¯æ•è·ç¯å¢ƒçš„åŒ¿åå‡½æ•°ï¼Œä¸¤è€…ç»“åˆå®ç° ripgrep é«˜æ•ˆçš„é“¾å¼æ•°æ®å¤„ç†ã€‚**

---

## ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### è¿­ä»£å™¨ä¸é—­åŒ…çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**è¿­ä»£å™¨ = èƒ½å¤Ÿé€ä¸ªäº§å‡ºå…ƒç´ çš„å¯¹è±¡**

**é—­åŒ… = å‡½æ•° + æ•è·çš„ç¯å¢ƒå˜é‡**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦è¿­ä»£å™¨å’Œé—­åŒ…ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•é«˜æ•ˆã€å®‰å…¨ã€ä¼˜é›…åœ°éå†å’Œè½¬æ¢æ•°æ®é›†åˆï¼Ÿ**

ä¼ ç»Ÿæ–¹å¼çš„å›°å¢ƒï¼š

| æ–¹å¼ | é—®é¢˜ |
|-----|------|
| æ‰‹åŠ¨ç´¢å¼•å¾ªç¯ | æ˜“å‡ºé”™ï¼ˆè¶Šç•Œï¼‰ã€ä»£ç å†—é•¿ã€éš¾ä»¥ç»„åˆ |
| å›è°ƒå‡½æ•° | æ— æ³•æ•è·ä¸Šä¸‹æ–‡ã€ç”Ÿå‘½å‘¨æœŸå¤æ‚ |
| é¢å‘å¯¹è±¡è¿­ä»£å™¨ | è¿è¡Œæ—¶å¼€é”€ã€å †åˆ†é…ã€è™šå‡½æ•°è°ƒç”¨ |

Rust çš„ç­”æ¡ˆæ˜¯ï¼š**é›¶æˆæœ¬è¿­ä»£å™¨ + ç±»å‹å®‰å…¨é—­åŒ…**

- ç¼–è¯‘æ—¶å±•å¼€ï¼Œæ— è¿è¡Œæ—¶å¼€é”€
- æƒ°æ€§æ±‚å€¼ï¼ŒæŒ‰éœ€è®¡ç®—
- é—­åŒ…ä¸æ‰€æœ‰æƒç³»ç»Ÿæ·±åº¦é›†æˆ

#### 3. è¿­ä»£å™¨ä¸é—­åŒ…çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šæŠ½è±¡ä¸æŸå¤±æ€§èƒ½ï¼ˆé›¶æˆæœ¬æŠ½è±¡ï¼‰

```rust
// é«˜çº§æŠ½è±¡å†™æ³•
let sum: i32 = (1..=100)
    .filter(|x| x % 2 == 0)
    .map(|x| x * x)
    .sum();

// ç¼–è¯‘åç­‰ä»·äºæ‰‹å†™çš„ for å¾ªç¯ï¼Œæ²¡æœ‰é¢å¤–å¼€é”€ï¼
```

##### ä»·å€¼2ï¼šä»£ç è¡¨è¾¾åŠ›ï¼ˆå£°æ˜å¼ç¼–ç¨‹ï¼‰

```rust
// å‘½ä»¤å¼ï¼šæè¿°"æ€ä¹ˆåš"
let mut results = Vec::new();
for file in files {
    if file.ends_with(".rs") {
        let content = read_file(&file);
        if content.contains("TODO") {
            results.push(file);
        }
    }
}

// å£°æ˜å¼ï¼šæè¿°"è¦ä»€ä¹ˆ"
let results: Vec<_> = files.iter()
    .filter(|f| f.ends_with(".rs"))
    .filter(|f| read_file(f).contains("TODO"))
    .collect();
```

##### ä»·å€¼3ï¼šå®‰å…¨çš„å‡½æ•°å¼ç¼–ç¨‹

```rust
// é—­åŒ…è‡ªåŠ¨æ¨æ–­æ•è·æ–¹å¼ï¼Œç¼–è¯‘å™¨ä¿è¯å®‰å…¨
let search_pattern = String::from("error");

// é—­åŒ…å€Ÿç”¨ search_patternï¼Œä¸è½¬ç§»æ‰€æœ‰æƒ
let matches: Vec<_> = lines.iter()
    .filter(|line| line.contains(&search_pattern))
    .collect();

println!("Pattern was: {}", search_pattern);  // âœ… ä»å¯ä½¿ç”¨
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ ripgrep çš„è®¾è®¡

**æ¨ç†é“¾ï¼š**
```
1. ripgrep éœ€è¦éå†å¤§é‡æ–‡ä»¶
   â†“
2. æ–‡ä»¶æ•°é‡å¯èƒ½å·¨å¤§ â†’ ä¸èƒ½ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜
   â†“
3. éœ€è¦æƒ°æ€§éå† â†’ è¿­ä»£å™¨æ¨¡å¼
   â†“
4. éå†è¿‡ç¨‹ä¸­éœ€è¦è¿‡æ»¤ï¼ˆ.gitignoreã€æ–‡ä»¶ç±»å‹ï¼‰
   â†“
5. è¿‡æ»¤é€»è¾‘æ˜¯åŠ¨æ€çš„ï¼ˆç”¨æˆ·æŒ‡å®šï¼‰â†’ é—­åŒ…
   â†“
6. é—­åŒ…éœ€è¦è®¿é—®é…ç½®ä¿¡æ¯ â†’ æ•è·ç¯å¢ƒ
   â†“
7. å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç† â†’ é—­åŒ…éœ€è¦ Send + Sync
   â†“
8. ç»“æœï¼šIterator + Closure = ripgrep çš„æ ¸å¿ƒæ•°æ®æµæ°´çº¿
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**è¿­ä»£å™¨æä¾›ç»Ÿä¸€çš„éå†æ¥å£å’Œæƒ°æ€§æ±‚å€¼ï¼Œé—­åŒ…æä¾›æºå¸¦ä¸Šä¸‹æ–‡çš„è¡Œä¸ºå°è£…ï¼Œä¸¤è€…ç»“åˆè®© Rust åœ¨ä¿æŒé«˜æ€§èƒ½çš„åŒæ—¶å®ç°ä¼˜é›…çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚**

---

## ã€æ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šIterator trait ğŸ”„

**è¿­ä»£å™¨æ˜¯å®ç°äº† `Iterator` trait çš„ç±»å‹ï¼Œæ ¸å¿ƒæ˜¯ `next()` æ–¹æ³•**

```rust
// Iterator trait çš„æ ¸å¿ƒå®šä¹‰
pub trait Iterator {
    type Item;  // è¿­ä»£äº§å‡ºçš„å…ƒç´ ç±»å‹

    fn next(&mut self) -> Option<Self::Item>;  // æ ¸å¿ƒæ–¹æ³•

    // è¿˜æœ‰ 70+ ä¸ªé»˜è®¤å®ç°çš„æ–¹æ³•...
}
```

**æ‰‹åŠ¨å®ç°ä¸€ä¸ªè¿­ä»£å™¨ï¼š**

```rust
struct Counter {
    current: u32,
    max: u32,
}

impl Counter {
    fn new(max: u32) -> Counter {
        Counter { current: 0, max }
    }
}

impl Iterator for Counter {
    type Item = u32;

    fn next(&mut self) -> Option<Self::Item> {
        if self.current < self.max {
            self.current += 1;
            Some(self.current)
        } else {
            None  // è¿­ä»£ç»“æŸ
        }
    }
}

fn main() {
    let counter = Counter::new(5);
    for num in counter {
        println!("{}", num);  // è¾“å‡º 1, 2, 3, 4, 5
    }
}
```

**è¿­ä»£å™¨çŠ¶æ€æœºå¯è§†åŒ–ï¼š**
```
åˆå§‹çŠ¶æ€          è°ƒç”¨ next()        è°ƒç”¨ next()        ...        è°ƒç”¨ next()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚current=0â”‚ â”€â”€â”€â–º â”‚current=1â”‚ â”€â”€â”€â–º  â”‚current=2â”‚  â”€â”€â”€â–º ... â”€â”€â”€â–º  â”‚current=5â”‚
â”‚ max=5   â”‚      â”‚è¿”å›Some(1)â”‚      â”‚è¿”å›Some(2)â”‚                 â”‚è¿”å› None â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœ¨ ripgrep æºç ä¸­çš„åº”ç”¨ï¼š**
- `walkdir::WalkDir` å®ç° Iteratorï¼Œæƒ°æ€§éå†ç›®å½•
- `BufReader::lines()` è¿”å›è¿­ä»£å™¨ï¼Œé€è¡Œè¯»å–æ–‡ä»¶
- `grep-searcher` ä¸­çš„åŒ¹é…ç»“æœä½œä¸ºè¿­ä»£å™¨è¿”å›

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šé—­åŒ…ä¸‰ç§å½¢å¼ ğŸ“¦

**é—­åŒ…æ ¹æ®å¦‚ä½•æ•è·ç¯å¢ƒå˜é‡ï¼Œåˆ†ä¸ºä¸‰ç§ traitï¼šFnã€FnMutã€FnOnce**

```rust
fn main() {
    let text = String::from("hello");
    let mut count = 0;
    let data = vec![1, 2, 3];

    // ===== Fn: ä¸å¯å˜å€Ÿç”¨ç¯å¢ƒ =====
    // å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œä¸ä¿®æ”¹ç¯å¢ƒ
    let print_text = || {
        println!("{}", text);  // å€Ÿç”¨ text
    };
    print_text();
    print_text();  // âœ… å¯ä»¥å¤šæ¬¡è°ƒç”¨

    // ===== FnMut: å¯å˜å€Ÿç”¨ç¯å¢ƒ =====
    // å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œä¼šä¿®æ”¹ç¯å¢ƒ
    let mut increment = || {
        count += 1;  // å¯å˜å€Ÿç”¨ count
        println!("count = {}", count);
    };
    increment();  // count = 1
    increment();  // count = 2

    // ===== FnOnce: è·å–ç¯å¢ƒæ‰€æœ‰æƒ =====
    // åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå› ä¸ºæ¶ˆè€—äº†æ•è·çš„å€¼
    let consume_data = || {
        let moved = data;  // ç§»åŠ¨ data çš„æ‰€æœ‰æƒ
        println!("{:?}", moved);
    };
    consume_data();
    // consume_data();  // âŒ ç¼–è¯‘é”™è¯¯ï¼åªèƒ½è°ƒç”¨ä¸€æ¬¡
}
```

**ä¸‰ç§é—­åŒ…çš„ç»§æ‰¿å…³ç³»ï¼š**
```
            FnOnceï¼ˆæ‰€æœ‰é—­åŒ…éƒ½å®ç°ï¼‰
               â–²
               â”‚
            FnMutï¼ˆä¸æ¶ˆè€—ç¯å¢ƒçš„é—­åŒ…å®ç°ï¼‰
               â–²
               â”‚
              Fnï¼ˆä¸ä¿®æ”¹ç¯å¢ƒçš„é—­åŒ…å®ç°ï¼‰

Fn âŠ‚ FnMut âŠ‚ FnOnce

å®ç° Fn çš„é—­åŒ…è‡ªåŠ¨å®ç° FnMut å’Œ FnOnce
```

**å‡½æ•°å‚æ•°é€‰æ‹©å»ºè®®ï¼š**
```rust
// æœ€çµæ´»ï¼šæ¥å—ä»»ä½•é—­åŒ…ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰
fn call_once<F: FnOnce()>(f: F) { f(); }

// å¯èƒ½å¤šæ¬¡è°ƒç”¨ï¼Œå¯èƒ½ä¿®æ”¹çŠ¶æ€
fn call_mut<F: FnMut()>(mut f: F) { f(); f(); }

// æœ€ä¸¥æ ¼ï¼šå¤šæ¬¡è°ƒç”¨ï¼Œä¸ä¿®æ”¹çŠ¶æ€
fn call_fn<F: Fn()>(f: F) { f(); f(); f(); }
```

**åœ¨ ripgrep æºç ä¸­çš„åº”ç”¨ï¼š**
- æœç´¢å›è°ƒä½¿ç”¨ `FnMut`ï¼šæ¯æ‰¾åˆ°ä¸€ä¸ªåŒ¹é…å°±è°ƒç”¨
- è¿‡æ»¤å™¨ä½¿ç”¨ `Fn`ï¼šåˆ¤æ–­æ–‡ä»¶æ˜¯å¦åº”è¯¥è¢«æœç´¢
- é…ç½®æ„å»ºå™¨ä½¿ç”¨ `FnOnce`ï¼šä¸€æ¬¡æ€§é…ç½®

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šæƒ°æ€§æ±‚å€¼ä¸é“¾å¼è°ƒç”¨ â›“ï¸

**è¿­ä»£å™¨é€‚é…å™¨æ˜¯æƒ°æ€§çš„ï¼Œåªæœ‰æ¶ˆè´¹è€…æ‰ä¼šè§¦å‘å®é™…è®¡ç®—**

```rust
fn main() {
    let numbers = vec![1, 2, 3, 4, 5];

    // ===== é€‚é…å™¨ï¼šæƒ°æ€§ï¼Œä¸ç«‹å³æ‰§è¡Œ =====
    let iter = numbers.iter()
        .map(|x| {
            println!("map: {}", x);  // ä¸ä¼šæ‰“å°ï¼
            x * 2
        })
        .filter(|x| {
            println!("filter: {}", x);  // ä¸ä¼šæ‰“å°ï¼
            *x > 4
        });

    println!("è¿­ä»£å™¨å·²åˆ›å»ºï¼Œä½†è¿˜æ²¡æœ‰æ‰§è¡Œä»»ä½•è®¡ç®—");

    // ===== æ¶ˆè´¹è€…ï¼šè§¦å‘è®¡ç®— =====
    let result: Vec<_> = iter.collect();  // ç°åœ¨æ‰æ‰§è¡Œï¼

    println!("ç»“æœ: {:?}", result);
}
```

**è¾“å‡ºï¼š**
```
è¿­ä»£å™¨å·²åˆ›å»ºï¼Œä½†è¿˜æ²¡æœ‰æ‰§è¡Œä»»ä½•è®¡ç®—
map: 1
filter: 2
map: 2
filter: 4
map: 3
filter: 6
map: 4
filter: 8
map: 5
filter: 10
ç»“æœ: [6, 8, 10]
```

**æƒ°æ€§æ±‚å€¼å¯è§†åŒ–ï¼š**
```
åˆ›å»ºé˜¶æ®µï¼ˆåªæ„å»ºç®¡é“ï¼Œä¸æ‰§è¡Œï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  iter() â”‚â”€â”€â”€â–ºâ”‚  map()  â”‚â”€â”€â”€â–ºâ”‚ filter()â”‚â”€â”€â”€â–º è¿”å› Iterator
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    æƒ°æ€§           æƒ°æ€§           æƒ°æ€§

æ¶ˆè´¹é˜¶æ®µï¼ˆcollect è§¦å‘æ‰§è¡Œï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ collect â”‚â—„â”€â”€â”€â”‚ filter  â”‚â—„â”€â”€â”€â”‚   map   â”‚â—„â”€â”€â”€â”‚  æ•°æ®æº  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   æ‹‰å–æ•°æ®       æŒ‰éœ€è¿‡æ»¤       æŒ‰éœ€è½¬æ¢       é€ä¸ªæä¾›
```

**å¸¸ç”¨é€‚é…å™¨å’Œæ¶ˆè´¹è€…ï¼š**

| é€‚é…å™¨ï¼ˆæƒ°æ€§ï¼‰ | ä½œç”¨ |
|--------------|------|
| `map(f)` | è½¬æ¢æ¯ä¸ªå…ƒç´  |
| `filter(p)` | ä¿ç•™æ»¡è¶³æ¡ä»¶çš„å…ƒç´  |
| `take(n)` | åªå–å‰ n ä¸ª |
| `skip(n)` | è·³è¿‡å‰ n ä¸ª |
| `enumerate()` | æ·»åŠ ç´¢å¼• |
| `flat_map(f)` | å±•å¹³åµŒå¥—è¿­ä»£å™¨ |
| `chain(iter)` | è¿æ¥ä¸¤ä¸ªè¿­ä»£å™¨ |
| `zip(iter)` | é…å¯¹ä¸¤ä¸ªè¿­ä»£å™¨ |

| æ¶ˆè´¹è€…ï¼ˆç«‹å³æ‰§è¡Œï¼‰ | ä½œç”¨ |
|-----------------|------|
| `collect()` | æ”¶é›†åˆ°é›†åˆ |
| `for_each(f)` | å¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡Œæ“ä½œ |
| `fold(init, f)` | æŠ˜å /å½’çº¦ |
| `sum()` / `product()` | æ±‚å’Œ/æ±‚ç§¯ |
| `find(p)` | æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é… |
| `any(p)` / `all(p)` | å­˜åœ¨/å…¨éƒ¨åˆ¤æ–­ |
| `count()` | è®¡æ•° |
| `nth(n)` | è·å–ç¬¬ n ä¸ª |

**åœ¨ ripgrep æºç ä¸­çš„åº”ç”¨ï¼š**
- æ–‡ä»¶éå†ï¼š`WalkDir::new(path).into_iter().filter_entry(...)`
- ç»“æœå¤„ç†ï¼šåŒ¹é…ç»“æœé€šè¿‡è¿­ä»£å™¨ç®¡é“å¤„ç†åè¾“å‡º
- æƒ°æ€§éå†é¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ–‡ä»¶åˆ°å†…å­˜

---

### æ ¸å¿ƒæ¦‚å¿µ4ï¼šé—­åŒ…æ•è·æœºåˆ¶ ğŸ¯

**é—­åŒ…è‡ªåŠ¨æ¨æ–­æ•è·æ–¹å¼ï¼šå€Ÿç”¨ â†’ å¯å˜å€Ÿç”¨ â†’ ç§»åŠ¨**

```rust
fn main() {
    let s = String::from("hello");
    let x = 10;

    // ===== è‡ªåŠ¨å€Ÿç”¨ï¼ˆé»˜è®¤æœ€å°æƒé™ï¼‰=====
    let closure1 = || {
        println!("{}", s);  // åªè¯»è®¿é—®ï¼Œè‡ªåŠ¨ä¸å¯å˜å€Ÿç”¨
    };
    closure1();
    println!("s still valid: {}", s);  // âœ… s ä»å¯ç”¨

    // ===== è‡ªåŠ¨å¯å˜å€Ÿç”¨ =====
    let mut vec = vec![1, 2, 3];
    let mut closure2 = || {
        vec.push(4);  // ä¿®æ”¹è®¿é—®ï¼Œè‡ªåŠ¨å¯å˜å€Ÿç”¨
    };
    closure2();
    println!("vec: {:?}", vec);  // âœ… vec å·²è¢«ä¿®æ”¹

    // ===== move å…³é”®å­—ï¼šå¼ºåˆ¶ç§»åŠ¨æ‰€æœ‰æƒ =====
    let data = vec![1, 2, 3];
    let closure3 = move || {
        println!("{:?}", data);  // data è¢«ç§»åŠ¨åˆ°é—­åŒ…ä¸­
    };
    closure3();
    // println!("{:?}", data);  // âŒ ç¼–è¯‘é”™è¯¯ï¼data å·²è¢«ç§»åŠ¨
}
```

**`move` å…³é”®å­—çš„å…¸å‹åœºæ™¯ï¼š**

```rust
use std::thread;

fn main() {
    let message = String::from("Hello from thread!");

    // è·¨çº¿ç¨‹å¿…é¡» moveï¼Œå› ä¸ºæ–°çº¿ç¨‹å¯èƒ½æ¯”ä¸»çº¿ç¨‹æ´»å¾—é•¿
    let handle = thread::spawn(move || {
        println!("{}", message);  // message è¢«ç§»åŠ¨åˆ°æ–°çº¿ç¨‹
    });

    // println!("{}", message);  // âŒ ç¼–è¯‘é”™è¯¯ï¼

    handle.join().unwrap();
}
```

**é—­åŒ…å†…å­˜å¸ƒå±€ï¼š**
```
æ™®é€šé—­åŒ…ï¼ˆæ•è·å¼•ç”¨ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Closure struct     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ &captured_var1 â”‚ â”‚  â† 8 bytes (æŒ‡é’ˆ)
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ &captured_var2 â”‚ â”‚  â† 8 bytes (æŒ‡é’ˆ)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å¤§å° = æ•è·çš„å¼•ç”¨æ•° Ã— æŒ‡é’ˆå¤§å°

move é—­åŒ…ï¼ˆæ•è·å€¼ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Closure struct     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ owned_string   â”‚ â”‚  â† 24 bytes (String)
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ owned_vec      â”‚ â”‚  â† 24 bytes (Vec)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å¤§å° = æ•è·å€¼çš„å¤§å°ä¹‹å’Œ
```

**åœ¨ ripgrep æºç ä¸­çš„åº”ç”¨ï¼š**
- å¹¶è¡Œæœç´¢ä¸­ï¼Œé…ç½®é€šè¿‡ `Arc` + `move` é—­åŒ…ä¼ é€’ç»™å·¥ä½œçº¿ç¨‹
- è¿‡æ»¤æ¡ä»¶é—­åŒ…æ•è· ignore è§„åˆ™
- ç»“æœå¤„ç†é—­åŒ…æ•è·è¾“å‡º sink

---

## ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹ 20% çš„æ ¸å¿ƒçŸ¥è¯†ï¼Œå°±èƒ½è§£å†³ 80% çš„è¿­ä»£å™¨å’Œé—­åŒ…é—®é¢˜ï¼š

### 1. ä¸‰ç§è·å–è¿­ä»£å™¨çš„æ–¹æ³•

```rust
let vec = vec![1, 2, 3];

// iter(): ä¸å¯å˜å€Ÿç”¨ï¼Œäº§å‡º &T
for item in vec.iter() {
    println!("{}", item);  // item æ˜¯ &i32
}
println!("{:?}", vec);  // âœ… vec ä»å¯ç”¨

// iter_mut(): å¯å˜å€Ÿç”¨ï¼Œäº§å‡º &mut T
let mut vec = vec![1, 2, 3];
for item in vec.iter_mut() {
    *item *= 2;  // item æ˜¯ &mut i32ï¼Œå¯ä¿®æ”¹
}
println!("{:?}", vec);  // [2, 4, 6]

// into_iter(): è·å–æ‰€æœ‰æƒï¼Œäº§å‡º T
let vec = vec![1, 2, 3];
for item in vec.into_iter() {
    println!("{}", item);  // item æ˜¯ i32
}
// println!("{:?}", vec);  // âŒ vec å·²è¢«æ¶ˆè€—
```

**é€‰æ‹©åŸåˆ™ï¼š**
- åªè¯»éå† â†’ `iter()`
- éœ€è¦ä¿®æ”¹ â†’ `iter_mut()`
- æ¶ˆè€—é›†åˆ â†’ `into_iter()`

### 2. æœ€å¸¸ç”¨çš„ 4 ä¸ªé€‚é…å™¨

```rust
let numbers = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

// map: è½¬æ¢æ¯ä¸ªå…ƒç´ 
let doubled: Vec<_> = numbers.iter().map(|x| x * 2).collect();
// [2, 4, 6, 8, 10, 12, 14, 16, 18, 20]

// filter: è¿‡æ»¤å…ƒç´ 
let evens: Vec<_> = numbers.iter().filter(|x| *x % 2 == 0).collect();
// [2, 4, 6, 8, 10]

// take: å–å‰ N ä¸ª
let first_three: Vec<_> = numbers.iter().take(3).collect();
// [1, 2, 3]

// enumerate: å¸¦ç´¢å¼•
for (index, value) in numbers.iter().enumerate() {
    println!("[{}] = {}", index, value);
}
```

### 3. æœ€å¸¸ç”¨çš„ 4 ä¸ªæ¶ˆè´¹è€…

```rust
let numbers = vec![1, 2, 3, 4, 5];

// collect: æ”¶é›†åˆ°é›†åˆï¼ˆæœ€å¸¸ç”¨ï¼ï¼‰
let vec: Vec<_> = numbers.iter().map(|x| x * 2).collect();

// for_each: å‰¯ä½œç”¨æ“ä½œ
numbers.iter().for_each(|x| println!("{}", x));

// find: æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…
let first_even = numbers.iter().find(|x| *x % 2 == 0);
println!("{:?}", first_even);  // Some(2)

// any / all: æ¡ä»¶åˆ¤æ–­
let has_even = numbers.iter().any(|x| x % 2 == 0);  // true
let all_positive = numbers.iter().all(|x| *x > 0);  // true
```

### 4. é—­åŒ…åŸºç¡€è¯­æ³•

```rust
// å®Œæ•´å½¢å¼
let add = |x: i32, y: i32| -> i32 { x + y };

// çœç•¥ç±»å‹ï¼ˆç¼–è¯‘å™¨æ¨æ–­ï¼‰
let add = |x, y| x + y;

// æ— å‚æ•°
let greet = || println!("Hello!");

// å•è¡¨è¾¾å¼å¯çœç•¥èŠ±æ‹¬å·
let double = |x| x * 2;

// å¤šè¯­å¥éœ€è¦èŠ±æ‹¬å·
let complex = |x| {
    let temp = x * 2;
    temp + 1
};
```

### 5. é“¾å¼è°ƒç”¨æ¨¡å¼

```rust
// ripgrep é£æ ¼çš„é“¾å¼å¤„ç†
let results: Vec<String> = files.iter()
    .filter(|f| f.ends_with(".rs"))           // è¿‡æ»¤ Rust æ–‡ä»¶
    .map(|f| std::fs::read_to_string(f))      // è¯»å–å†…å®¹
    .filter_map(|r| r.ok())                    // å¿½ç•¥è¯»å–å¤±è´¥çš„
    .filter(|content| content.contains("TODO")) // åŒ…å« TODO
    .collect();
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- å¤„ç†å¤§éƒ¨åˆ†é›†åˆéå†å’Œè½¬æ¢éœ€æ±‚
- ç¼–å†™ ripgrep é£æ ¼çš„æ•°æ®å¤„ç†ç®¡é“
- ç†è§£å¤§éƒ¨åˆ† Rust ä»£ç ä¸­çš„è¿­ä»£å™¨ç”¨æ³•
- ä¸ºå­¦ä¹ æ›´é«˜çº§çš„å¹¶è¡Œè¿­ä»£å™¨ï¼ˆrayonï¼‰æ‰“åŸºç¡€

---

## ã€ç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šè¿­ä»£å™¨ = ç¿»ä¹¦ / æ•°ç»„æ–¹æ³•é“¾

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šIterator = Array æ–¹æ³•é“¾

Rust çš„è¿­ä»£å™¨é“¾å¼è°ƒç”¨å’Œ JavaScript çš„æ•°ç»„æ–¹æ³•éå¸¸ç›¸ä¼¼ï¼š

```javascript
// JavaScript
const results = files
    .filter(f => f.endsWith('.rs'))
    .map(f => readFile(f))
    .filter(content => content.includes('TODO'));
```

```rust
// Rust
let results: Vec<_> = files.iter()
    .filter(|f| f.ends_with(".rs"))
    .map(|f| read_file(f))
    .filter(|content| content.contains("TODO"))
    .collect();
```

**å…³é”®åŒºåˆ«ï¼š**

| ç‰¹æ€§ | JavaScript | Rust |
|-----|-----------|------|
| æ±‚å€¼æ–¹å¼ | ç«‹å³æ‰§è¡Œ | æƒ°æ€§æ±‚å€¼ |
| æ¯ä¸€æ­¥ | åˆ›å»ºæ–°æ•°ç»„ | ä¸åˆ›å»ºä¸­é—´æ•°ç»„ |
| æ€§èƒ½ | å¤šæ¬¡éå† | å•æ¬¡éå† |
| ç±»å‹å®‰å…¨ | è¿è¡Œæ—¶æ£€æŸ¥ | ç¼–è¯‘æ—¶æ£€æŸ¥ |

```javascript
// JS: æ¯ä¸€æ­¥éƒ½åˆ›å»ºæ–°æ•°ç»„ï¼Œéå† 3 æ¬¡
[1,2,3,4,5]
    .filter(x => x > 2)    // éå† 5 æ¬¡ï¼Œåˆ›å»º [3,4,5]
    .map(x => x * 2)       // éå† 3 æ¬¡ï¼Œåˆ›å»º [6,8,10]
    .filter(x => x > 7);   // éå† 3 æ¬¡ï¼Œåˆ›å»º [8,10]
```

```rust
// Rust: å•æ¬¡éå†ï¼Œæ— ä¸­é—´æ•°ç»„
vec![1,2,3,4,5].iter()
    .filter(|x| **x > 2)   // æƒ°æ€§
    .map(|x| x * 2)        // æƒ°æ€§
    .filter(|x| *x > 7)    // æƒ°æ€§
    .collect::<Vec<_>>();  // ä¸€æ¬¡éå†å®Œæˆæ‰€æœ‰æ“ä½œï¼
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šè¿­ä»£å™¨ = ä¸€é¡µé¡µç¿»ä¹¦

æƒ³è±¡ä½ æœ‰ä¸€æœ¬å¾ˆåšçš„å›¾ç”»ä¹¦ï¼š

**æ™®é€šæ–¹å¼ï¼ˆç«‹å³æ‰§è¡Œï¼‰ï¼š**
æŠŠæ•´æœ¬ä¹¦å¤å°ä¸€ä»½ï¼Œç„¶ååœ¨å¤å°ä»¶ä¸Šæ ‡è®°æœ‰è¶£çš„é¡µï¼Œå†å¤å°ä¸€ä»½åªæœ‰æœ‰è¶£é¡µçš„ä¹¦...å¤ªæµªè´¹çº¸äº†ï¼

**è¿­ä»£å™¨æ–¹å¼ï¼ˆæƒ°æ€§æ±‚å€¼ï¼‰ï¼š**
ä½ ä»ç¬¬ä¸€é¡µå¼€å§‹ç¿»ï¼Œæ¯ç¿»åˆ°ä¸€é¡µå°±é—®è‡ªå·±ï¼š
1. è¿™é¡µæœ‰è¶£å—ï¼Ÿï¼ˆfilterï¼‰
2. å¦‚æœæœ‰è¶£ï¼Œæˆ‘è¦æ€ä¹ˆæ”¹å˜å®ƒï¼Ÿï¼ˆmapï¼‰
3. è¿™æ˜¯æˆ‘è¦çš„å—ï¼Ÿ

åªæœ‰çœŸæ­£éœ€è¦çš„é¡µæ‰ä¼šè¢«å¤„ç†ï¼Œä¸éœ€è¦å¤å°æ•´æœ¬ä¹¦ï¼

**ç”Ÿæ´»ä¾‹å­ï¼š**
```
æ‰¾ç­çº§é‡Œå–œæ¬¢è¶³çƒçš„é«˜ä¸ªå­åŒå­¦ï¼š

âŒ ä½æ•ˆæ–¹å¼ï¼š
1. å…ˆæŠŠæ‰€æœ‰åŒå­¦åå­—æŠ„ä¸€ä»½ï¼ˆå¤åˆ¶ï¼‰
2. åˆ æ‰ä¸å–œæ¬¢è¶³çƒçš„ï¼ˆè¿‡æ»¤ï¼‰
3. å†æŠ„ä¸€ä»½é«˜ä¸ªå­çš„ï¼ˆå†å¤åˆ¶ï¼‰

âœ… è¿­ä»£å™¨æ–¹å¼ï¼š
ä¾æ¬¡é—®æ¯ä¸ªåŒå­¦ï¼š
"ä½ å–œæ¬¢è¶³çƒå—ï¼Ÿ" â†’ "ä½ å¤šé«˜ï¼Ÿ" â†’ è®°ä¸‹æ¥æˆ–è·³è¿‡
åªé—®å¿…è¦çš„é—®é¢˜ï¼Œé‡åˆ°ç¬¦åˆæ¡ä»¶çš„å°±è®°ä¸‹æ¥
```

---

### ç±»æ¯”2ï¼šé—­åŒ… = ç®­å¤´å‡½æ•° / å¸¦èƒŒåŒ…çš„å°åŠ©æ‰‹

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šé—­åŒ… = ç®­å¤´å‡½æ•°

```javascript
// JavaScript ç®­å¤´å‡½æ•°
const multiplier = 2;
const double = (x) => x * multiplier;  // æ•è· multiplier

// Rust é—­åŒ…
let multiplier = 2;
let double = |x| x * multiplier;  // æ•è· multiplier
```

**å…³é”®åŒºåˆ«ï¼š**

```javascript
// JavaScript: é—­åŒ…é™·é˜±
for (var i = 0; i < 3; i++) {
    setTimeout(() => console.log(i), 100);  // è¾“å‡º 3, 3, 3
}

// è§£å†³æ–¹æ¡ˆï¼šç«‹å³æ‰§è¡Œå‡½æ•°åˆ›å»ºæ–°ä½œç”¨åŸŸ
for (var i = 0; i < 3; i++) {
    ((j) => {
        setTimeout(() => console.log(j), 100);
    })(i);  // è¾“å‡º 0, 1, 2
}
```

```rust
// Rust: ç¼–è¯‘å™¨å¼ºåˆ¶ä½ æ˜ç¡®æ„å›¾
for i in 0..3 {
    // é»˜è®¤å€Ÿç”¨ i
    let closure = || println!("{}", i);

    // å¦‚æœè¦ç§»åŠ¨æ‰€æœ‰æƒï¼ˆç±»ä¼¼ JS ç«‹å³æ‰§è¡Œå‡½æ•°ï¼‰
    let closure = move || println!("{}", i);
}
// ç¼–è¯‘å™¨ä¿è¯ä½ ä¸ä¼šé‡åˆ° "é—­åŒ…é™·é˜±"ï¼
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šé—­åŒ… = å¸¦èƒŒåŒ…çš„å°åŠ©æ‰‹

æƒ³è±¡ä½ æ´¾ä¸€ä¸ªå°åŠ©æ‰‹å»å¸®ä½ ä¹°ä¸œè¥¿ï¼š

**æ™®é€šå‡½æ•° = åªå¬æŒ‡ä»¤çš„åŠ©æ‰‹ï¼š**
"å»ä¹° 3 ä¸ªè‹¹æœ" â†’ åŠ©æ‰‹åªçŸ¥é“ä¹°è‹¹æœï¼Œä¸çŸ¥é“ä½ å–œæ¬¢ä»€ä¹ˆé¢œè‰²

**é—­åŒ… = å¸¦èƒŒåŒ…çš„åŠ©æ‰‹ï¼š**
åŠ©æ‰‹èƒŒç€ä¸€ä¸ªå°èƒŒåŒ…ï¼Œé‡Œé¢è£…ç€ä½ çš„å–œå¥½æ¸…å•ï¼š
- å–œæ¬¢çº¢è‰²
- é¢„ç®— 50 å…ƒ
- ä¸è¦å¤ªå¤§çš„

"å»ä¹°è‹¹æœ" â†’ åŠ©æ‰‹ä¼šæ ¹æ®èƒŒåŒ…é‡Œçš„å–œå¥½æŒ‘é€‰

```rust
let favorite_color = "red";
let budget = 50;

// é—­åŒ… = å¸¦ç€ favorite_color å’Œ budget çš„å°åŠ©æ‰‹
let buy_apples = |count| {
    println!("ä¹° {} ä¸ª {} è‹¹æœï¼Œé¢„ç®— {} å…ƒ",
             count, favorite_color, budget);
};

buy_apples(3);  // ä¹° 3 ä¸ª red è‹¹æœï¼Œé¢„ç®— 50 å…ƒ
```

**ä¸‰ç§èƒŒåŒ…æ–¹å¼ï¼ˆFn / FnMut / FnOnceï¼‰ï¼š**

| æ–¹å¼ | ç±»æ¯” | è§£é‡Š |
|-----|-----|------|
| `Fn` | çœ‹ä¸€çœ¼æ¸…å• | åªè¯»èƒŒåŒ…å†…å®¹ï¼Œä¸æ”¹å˜ |
| `FnMut` | å¯ä»¥å¾€æ¸…å•ä¸ŠåŠ ä¸œè¥¿ | å¯ä»¥ä¿®æ”¹èƒŒåŒ…å†…å®¹ |
| `FnOnce` | æŠŠèƒŒåŒ…é€äºº | ç”¨å®ŒèƒŒåŒ…å°±æ²¡äº† |

---

### ç±»æ¯”3ï¼šmove é—­åŒ… = æ¬å®¶ / å¤åˆ¶ä½œä¸š

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šmove = æ·±æ‹·è´ + è½¬ç§»

```javascript
// JavaScript: éœ€è¦æ‰‹åŠ¨æ·±æ‹·è´
const data = { items: [1, 2, 3] };
const worker = new Worker('worker.js');

// é”™è¯¯ï¼šdata å¯èƒ½åœ¨ worker ä½¿ç”¨æ—¶è¢«ä¿®æ”¹
worker.postMessage(data);

// æ­£ç¡®ï¼šæ·±æ‹·è´æ•°æ®
worker.postMessage(JSON.parse(JSON.stringify(data)));
```

```rust
// Rust: move è¯­ä¹‰è‡ªåŠ¨å¤„ç†
let data = vec![1, 2, 3];

thread::spawn(move || {
    // data è¢«ç§»åŠ¨åˆ°æ–°çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹æ— æ³•å†ä½¿ç”¨
    println!("{:?}", data);
});

// data åœ¨è¿™é‡Œå·²ä¸å¯ç”¨ï¼Œç¼–è¯‘å™¨ä¿è¯çº¿ç¨‹å®‰å…¨
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šmove = æŠŠç©å…·é€ç»™æœ‹å‹

**ä¸ç”¨ moveï¼ˆå€Ÿç”¨ï¼‰ï¼š**
ä½ æŠŠç©å…·å€Ÿç»™æœ‹å‹ç©ä¸€ä¼šå„¿ï¼Œç©å®Œè¿˜ç»™ä½ 
```rust
let toy = String::from("å°ç†Š");
let play = || println!("ç© {}", toy);  // å€Ÿç©å…·
play();
println!("æˆ‘çš„ {}", toy);  // âœ… ç©å…·è¿˜æ˜¯æˆ‘çš„
```

**ä½¿ç”¨ moveï¼ˆè½¬ç§»æ‰€æœ‰æƒï¼‰ï¼š**
ä½ æŠŠç©å…·é€ç»™æœ‹å‹ï¼Œä»¥åå°±æ˜¯æœ‹å‹çš„äº†
```rust
let toy = String::from("å°ç†Š");
let give_away = move || println!("é€å‡º {}", toy);  // é€ç©å…·
give_away();
// println!("æˆ‘çš„ {}", toy);  // âŒ ç©å…·å·²ç»é€äººäº†ï¼
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| Rust æ¦‚å¿µ | å‰ç«¯ç±»æ¯” | å°æœ‹å‹ç±»æ¯” |
|----------|---------|-----------|
| Iterator | `array.map().filter()` | ä¸€é¡µé¡µç¿»ä¹¦ |
| æƒ°æ€§æ±‚å€¼ | Generator / `function*` | é—®åˆ°æ‰å›ç­” |
| collect() | è¿”å›æ–°æ•°ç»„ | æŠŠé€‰ä¸­çš„å¤å°æˆæ–°ä¹¦ |
| é—­åŒ… | ç®­å¤´å‡½æ•° `() => {}` | å¸¦èƒŒåŒ…çš„å°åŠ©æ‰‹ |
| æ•è·å˜é‡ | é—­åŒ…ä½œç”¨åŸŸ | èƒŒåŒ…é‡Œçš„ç‰©å“ |
| move | æ·±æ‹·è´ + è§£é™¤å¼•ç”¨ | æŠŠç©å…·é€äºº |
| Fn | çº¯å‡½æ•° | åªçœ‹æ¸…å• |
| FnMut | å¸¦å‰¯ä½œç”¨å‡½æ•° | å¯ä»¥æ”¹æ¸…å• |
| FnOnce | ä¸€æ¬¡æ€§å‡½æ•° | ç”¨å®ŒèƒŒåŒ…å°±æ²¡äº† |

---

## ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šè¿­ä»£å™¨æ¯” for å¾ªç¯æ…¢ âŒ

**é”™è¯¯è§‚ç‚¹ï¼š**
"è¿­ä»£å™¨é“¾è¿™ä¹ˆå¤šæ–¹æ³•è°ƒç”¨ï¼Œè‚¯å®šæ¯”æ‰‹å†™ for å¾ªç¯æ…¢"

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

Rust çš„è¿­ä»£å™¨æ˜¯**é›¶æˆæœ¬æŠ½è±¡**ï¼Œç¼–è¯‘å™¨ä¼šå°†è¿­ä»£å™¨é“¾å†…è”å±•å¼€æˆç­‰ä»·çš„ for å¾ªç¯ï¼

```rust
// è¿­ä»£å™¨å†™æ³•
let sum: i32 = (1..=1000)
    .filter(|x| x % 2 == 0)
    .map(|x| x * x)
    .sum();

// ç¼–è¯‘åç­‰ä»·äºï¼š
let mut sum = 0;
for x in 1..=1000 {
    if x % 2 == 0 {
        sum += x * x;
    }
}
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

1. å…¶ä»–è¯­è¨€ï¼ˆå¦‚ Java Streamï¼‰ç¡®å®æœ‰è¿è¡Œæ—¶å¼€é”€
2. æ–¹æ³•é“¾"çœ‹èµ·æ¥"åƒå¾ˆå¤šå‡½æ•°è°ƒç”¨
3. æ²¡æœ‰ç†è§£ Rust çš„å•æ€åŒ–ï¼ˆmonomorphizationï¼‰æœºåˆ¶

**æ­£ç¡®ç†è§£ï¼š**
```rust
// åŸºå‡†æµ‹è¯•è¯æ˜ï¼šä¸¤è€…æ€§èƒ½ç›¸åŒ
// è¿­ä»£å™¨ç‰ˆæœ¬æœ‰æ—¶ç”šè‡³æ›´å¿«ï¼Œå› ä¸ºç¼–è¯‘å™¨æ›´å®¹æ˜“ä¼˜åŒ–

use criterion::{black_box, criterion_group, criterion_main, Criterion};

fn iterator_sum(n: i32) -> i32 {
    (1..=n).filter(|x| x % 2 == 0).map(|x| x * x).sum()
}

fn loop_sum(n: i32) -> i32 {
    let mut sum = 0;
    for x in 1..=n {
        if x % 2 == 0 {
            sum += x * x;
        }
    }
    sum
}

// ä¸¤è€…æ€§èƒ½å‡ ä¹ç›¸åŒï¼Œè¿­ä»£å™¨ç‰ˆæœ¬æ›´æ˜“è¯»ï¼
```

---

### è¯¯åŒº2ï¼šé—­åŒ…éƒ½ä¼šå‘ç”Ÿå †åˆ†é… âŒ

**é”™è¯¯è§‚ç‚¹ï¼š**
"é—­åŒ…æ˜¯åŒ¿åå¯¹è±¡ï¼Œè‚¯å®šè¦åœ¨å †ä¸Šåˆ†é…å†…å­˜"

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

Rust çš„é—­åŒ…é»˜è®¤åœ¨**æ ˆä¸Šåˆ†é…**ï¼Œåªæœ‰ä½¿ç”¨ `Box<dyn Fn()>` ç­‰ trait object æ—¶æ‰ä¼šå †åˆ†é…ã€‚

```rust
fn main() {
    let x = 10;

    // æ ˆåˆ†é…ï¼é—­åŒ…å°±æ˜¯ä¸€ä¸ªåŒ…å« &x çš„ç»“æ„ä½“
    let closure = |y| x + y;

    // é—­åŒ…å¤§å° = æ•è·å˜é‡çš„å¤§å°
    println!("é—­åŒ…å¤§å°: {} bytes", std::mem::size_of_val(&closure));
    // è¾“å‡º: é—­åŒ…å¤§å°: 8 bytesï¼ˆä¸€ä¸ªæŒ‡é’ˆçš„å¤§å°ï¼‰

    // åªæœ‰ trait object æ‰ä¼šå †åˆ†é…
    let boxed: Box<dyn Fn(i32) -> i32> = Box::new(closure);  // å †åˆ†é…
}
```

**é—­åŒ…çš„çœŸå®å†…å­˜å¸ƒå±€ï¼š**
```
// è¿™ä¸ªé—­åŒ…
let x = 10;
let y = String::from("hello");
let closure = || println!("{} {}", x, y);

// ç¼–è¯‘å™¨ç”Ÿæˆç±»ä¼¼è¿™æ ·çš„ç»“æ„ä½“ï¼ˆåœ¨æ ˆä¸Šï¼‰
struct AnonymousClosure<'a> {
    x: &'a i32,       // 8 bytes
    y: &'a String,    // 8 bytes
}
// æ€»å¤§å°: 16 bytesï¼Œåœ¨æ ˆä¸Š
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

1. å…¶ä»–è¯­è¨€ï¼ˆå¦‚ JavaScriptï¼‰çš„é—­åŒ…ç¡®å®æœ‰é¢å¤–å¼€é”€
2. "é—­åŒ…"è¿™ä¸ªåå­—å¬èµ·æ¥åƒæ˜¯éœ€è¦ç‰¹æ®Šå¤„ç†çš„ä¸œè¥¿
3. æ²¡æœ‰ç†è§£ Rust ç¼–è¯‘å™¨å¦‚ä½•å°†é—­åŒ…å•æ€åŒ–

**æ­£ç¡®ç†è§£ï¼š**
```rust
// é—­åŒ… = è‡ªåŠ¨ç”Ÿæˆçš„ç»“æ„ä½“ + è‡ªåŠ¨å®ç°çš„ trait
// å®Œå…¨æ²¡æœ‰è¿è¡Œæ—¶å¼€é”€ï¼

// è¿™ä¸¤ç§å†™æ³•æ€§èƒ½ç›¸åŒï¼š
let closure = |x: i32| x + 1;
fn add_one(x: i32) -> i32 { x + 1 }
```

---

### è¯¯åŒº3ï¼šiter() å’Œ into_iter() ä¸€æ · âŒ

**é”™è¯¯è§‚ç‚¹ï¼š**
"åæ­£éƒ½æ˜¯è¿­ä»£ï¼Œiter() å’Œ into_iter() æ²¡åŒºåˆ«"

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

å®ƒä»¬åœ¨**æ‰€æœ‰æƒ**å¤„ç†ä¸Šå®Œå…¨ä¸åŒï¼š

| æ–¹æ³• | äº§å‡ºç±»å‹ | åŸé›†åˆçŠ¶æ€ |
|-----|---------|----------|
| `iter()` | `&T` | ä¿æŒä¸å˜ |
| `iter_mut()` | `&mut T` | ä¿æŒä¸å˜ï¼ˆå…ƒç´ å¯ä¿®æ”¹ï¼‰ |
| `into_iter()` | `T` | è¢«æ¶ˆè€— |

```rust
let vec = vec![String::from("a"), String::from("b")];

// iter(): å€Ÿç”¨ï¼Œvec ä¿æŒä¸å˜
for s in vec.iter() {
    println!("{}", s);  // s æ˜¯ &String
}
println!("{:?}", vec);  // âœ… vec ä»å¯ç”¨

// into_iter(): æ¶ˆè€—ï¼Œvec ä¸å†å¯ç”¨
let vec = vec![String::from("a"), String::from("b")];
for s in vec.into_iter() {
    println!("{}", s);  // s æ˜¯ Stringï¼Œæ‰€æœ‰æƒè½¬ç§»
}
// println!("{:?}", vec);  // âŒ ç¼–è¯‘é”™è¯¯ï¼vec å·²è¢«æ¶ˆè€—
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

1. åœ¨ `for` å¾ªç¯ä¸­ç›´æ¥ä½¿ç”¨é›†åˆæ—¶ï¼Œéšå¼è°ƒç”¨ `into_iter()`
2. å¯¹äº `Copy` ç±»å‹ï¼ˆå¦‚ `i32`ï¼‰ï¼Œä¸¤è€…è¡¨ç°ç›¸ä¼¼
3. æ²¡æœ‰æ³¨æ„åˆ°æ–¹æ³•åä¸­çš„ "into"ï¼ˆè¡¨ç¤ºæ¶ˆè€—/è½¬æ¢ï¼‰

**å…³é”®åŒºåˆ†ï¼š**
```rust
// for å¾ªç¯çš„è„±ç³–ï¼š
for item in vec { }      // ç­‰ä»·äº for item in vec.into_iter() { }
for item in &vec { }     // ç­‰ä»·äº for item in vec.iter() { }
for item in &mut vec { } // ç­‰ä»·äº for item in vec.iter_mut() { }
```

---

## ã€å®æˆ˜ä»£ç ã€‘

```rust
//! ç¤ºä¾‹ï¼šripgrep é£æ ¼çš„æ–‡ä»¶æœç´¢
//! æ¼”ç¤ºè¿­ä»£å™¨å’Œé—­åŒ…åœ¨å®é™…åœºæ™¯ä¸­çš„åº”ç”¨

use std::fs;
use std::path::{Path, PathBuf};

fn main() {
    // ===== 1. åŸºç¡€è¿­ä»£å™¨é“¾ =====
    println!("=== 1. åŸºç¡€è¿­ä»£å™¨é“¾ ===");

    let numbers = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

    // æ‰¾å‡ºæ‰€æœ‰å¶æ•°çš„å¹³æ–¹
    let even_squares: Vec<i32> = numbers.iter()
        .filter(|n| *n % 2 == 0)
        .map(|n| n * n)
        .collect();

    println!("å¶æ•°çš„å¹³æ–¹: {:?}", even_squares);
    // è¾“å‡º: å¶æ•°çš„å¹³æ–¹: [4, 16, 36, 64, 100]

    // ===== 2. é—­åŒ…æ•è·ç¯å¢ƒ =====
    println!("\n=== 2. é—­åŒ…æ•è·ç¯å¢ƒ ===");

    let threshold = 5;
    let multiplier = 2;

    // é—­åŒ…æ•è· threshold å’Œ multiplier
    let process: Vec<i32> = numbers.iter()
        .filter(|n| **n > threshold)  // æ•è· threshold
        .map(|n| n * multiplier)       // æ•è· multiplier
        .collect();

    println!("å¤§äº {} çš„æ•°ä¹˜ä»¥ {}: {:?}", threshold, multiplier, process);
    // è¾“å‡º: å¤§äº 5 çš„æ•°ä¹˜ä»¥ 2: [12, 14, 16, 18, 20]

    // ===== 3. æ¨¡æ‹Ÿæ–‡ä»¶æœç´¢ =====
    println!("\n=== 3. æ¨¡æ‹Ÿæ–‡ä»¶æœç´¢ ===");

    // æ¨¡æ‹Ÿæ–‡ä»¶åˆ—è¡¨
    let files = vec![
        "src/main.rs",
        "src/lib.rs",
        "tests/test.rs",
        "README.md",
        "Cargo.toml",
        "target/debug/main",
    ];

    // ripgrep é£æ ¼ï¼šåªæœç´¢ .rs æ–‡ä»¶ï¼Œæ’é™¤ target ç›®å½•
    let rust_files: Vec<&str> = files.iter()
        .filter(|f| !f.starts_with("target/"))  // æ’é™¤ target
        .filter(|f| f.ends_with(".rs"))         // åªè¦ .rs
        .copied()
        .collect();

    println!("Rust æºæ–‡ä»¶: {:?}", rust_files);
    // è¾“å‡º: Rust æºæ–‡ä»¶: ["src/main.rs", "src/lib.rs", "tests/test.rs"]

    // ===== 4. ä½¿ç”¨ enumerate æ·»åŠ è¡Œå· =====
    println!("\n=== 4. å¸¦è¡Œå·çš„æœç´¢ç»“æœ ===");

    let content = "fn main() {
    println!(\"Hello\");
    // TODO: add error handling
    let x = 42;
    // TODO: refactor this
}";

    let search_term = "TODO";

    // æ¨¡æ‹Ÿ grep -n åŠŸèƒ½
    let matches: Vec<(usize, &str)> = content.lines()
        .enumerate()
        .filter(|(_, line)| line.contains(search_term))
        .map(|(num, line)| (num + 1, line.trim()))  // è¡Œå·ä» 1 å¼€å§‹
        .collect();

    for (line_num, line) in &matches {
        println!("{}:{}", line_num, line);
    }
    // è¾“å‡º:
    // 3:// TODO: add error handling
    // 5:// TODO: refactor this

    // ===== 5. fold å®ç°å¤æ‚èšåˆ =====
    println!("\n=== 5. ç»Ÿè®¡ä¿¡æ¯ ===");

    let words = vec!["hello", "world", "rust", "is", "awesome"];

    // ä½¿ç”¨ fold è®¡ç®—æ€»é•¿åº¦å’Œæœ€é•¿å•è¯
    let (total_len, longest) = words.iter()
        .fold((0usize, ""), |(len, longest), word| {
            let new_len = len + word.len();
            let new_longest = if word.len() > longest.len() { word } else { longest };
            (new_len, new_longest)
        });

    println!("æ€»å­—ç¬¦æ•°: {}, æœ€é•¿å•è¯: {}", total_len, longest);
    // è¾“å‡º: æ€»å­—ç¬¦æ•°: 22, æœ€é•¿å•è¯: awesome

    // ===== 6. flat_map å±•å¹³åµŒå¥— =====
    println!("\n=== 6. å±•å¹³åµŒå¥—ç»“æ„ ===");

    let nested = vec![vec![1, 2, 3], vec![4, 5], vec![6, 7, 8, 9]];

    let flattened: Vec<i32> = nested.iter()
        .flat_map(|inner| inner.iter())
        .copied()
        .collect();

    println!("å±•å¹³å: {:?}", flattened);
    // è¾“å‡º: å±•å¹³å: [1, 2, 3, 4, 5, 6, 7, 8, 9]

    // ===== 7. é“¾å¼æ¡ä»¶è¿‡æ»¤ (ripgrep é£æ ¼) =====
    println!("\n=== 7. ripgrep é£æ ¼è¿‡æ»¤é“¾ ===");

    #[derive(Debug)]
    struct SearchResult {
        file: String,
        line_num: usize,
        content: String,
    }

    // æ¨¡æ‹Ÿæœç´¢ç»“æœ
    let results = vec![
        SearchResult { file: "src/main.rs".into(), line_num: 10, content: "let x = 1;".into() },
        SearchResult { file: "src/lib.rs".into(), line_num: 5, content: "pub fn foo()".into() },
        SearchResult { file: "tests/test.rs".into(), line_num: 3, content: "let x = 2;".into() },
        SearchResult { file: "src/main.rs".into(), line_num: 20, content: "let y = x;".into() },
    ];

    let pattern = "let";
    let only_src = true;

    // åŠ¨æ€æ„å»ºè¿‡æ»¤æ¡ä»¶
    let filtered: Vec<_> = results.iter()
        .filter(|r| r.content.contains(pattern))
        .filter(|r| !only_src || r.file.starts_with("src/"))
        .collect();

    for result in filtered {
        println!("{}:{}:{}", result.file, result.line_num, result.content);
    }
    // è¾“å‡º:
    // src/main.rs:10:let x = 1;
    // src/main.rs:20:let y = x;

    // ===== 8. ä½¿ç”¨ take_while å’Œ skip_while =====
    println!("\n=== 8. æ¡ä»¶æˆªå– ===");

    let data = vec![1, 2, 3, 10, 11, 12, 4, 5, 6];

    // å–åˆ°ç¬¬ä¸€ä¸ª >= 10 çš„å…ƒç´ ä¸ºæ­¢
    let before_ten: Vec<_> = data.iter()
        .take_while(|x| **x < 10)
        .copied()
        .collect();
    println!("10 ä¹‹å‰: {:?}", before_ten);
    // è¾“å‡º: 10 ä¹‹å‰: [1, 2, 3]

    // è·³è¿‡æ‰€æœ‰ < 10 çš„å…ƒç´ 
    let from_ten: Vec<_> = data.iter()
        .skip_while(|x| **x < 10)
        .copied()
        .collect();
    println!("ä» 10 å¼€å§‹: {:?}", from_ten);
    // è¾“å‡º: ä» 10 å¼€å§‹: [10, 11, 12, 4, 5, 6]

    // ===== 9. è‡ªå®šä¹‰è¿­ä»£å™¨ =====
    println!("\n=== 9. è‡ªå®šä¹‰è¿­ä»£å™¨ ===");

    struct LineIterator<'a> {
        content: &'a str,
        position: usize,
    }

    impl<'a> LineIterator<'a> {
        fn new(content: &'a str) -> Self {
            LineIterator { content, position: 0 }
        }
    }

    impl<'a> Iterator for LineIterator<'a> {
        type Item = (usize, &'a str);

        fn next(&mut self) -> Option<Self::Item> {
            if self.position >= self.content.len() {
                return None;
            }

            let start = self.position;
            let remaining = &self.content[start..];

            let end = remaining.find('\n')
                .map(|i| start + i)
                .unwrap_or(self.content.len());

            let line_num = self.content[..start].matches('\n').count() + 1;
            let line = &self.content[start..end];

            self.position = end + 1;

            Some((line_num, line))
        }
    }

    let text = "first line\nsecond line\nthird line";
    let lines_with_nums: Vec<_> = LineIterator::new(text).collect();

    for (num, line) in lines_with_nums {
        println!("{}: {}", num, line);
    }
    // è¾“å‡º:
    // 1: first line
    // 2: second line
    // 3: third line

    // ===== 10. å¹¶è¡Œå‹å¥½çš„æ¨¡å¼ï¼ˆä¸º rayon å‡†å¤‡ï¼‰=====
    println!("\n=== 10. å¯å¹¶è¡ŒåŒ–çš„è¿­ä»£æ¨¡å¼ ===");

    // è¿™ç§å†™æ³•å¾ˆå®¹æ˜“è½¬æ¢ä¸ºå¹¶è¡Œç‰ˆæœ¬
    // åªéœ€è¦å°† .iter() æ”¹ä¸º .par_iter() (ä½¿ç”¨ rayon)
    let numbers: Vec<i32> = (1..=100).collect();

    let sum: i32 = numbers.iter()
        .filter(|n| *n % 2 == 0)
        .map(|n| n * n)
        .sum();

    println!("1-100 å¶æ•°å¹³æ–¹å’Œ: {}", sum);
    // è¾“å‡º: 1-100 å¶æ•°å¹³æ–¹å’Œ: 171700

    // ä½¿ç”¨ rayon åªéœ€æ”¹ä¸€è¡Œï¼š
    // use rayon::prelude::*;
    // let sum: i32 = numbers.par_iter()  // å¹¶è¡Œï¼
    //     .filter(|n| *n % 2 == 0)
    //     .map(|n| n * n)
    //     .sum();
}
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**
```
=== 1. åŸºç¡€è¿­ä»£å™¨é“¾ ===
å¶æ•°çš„å¹³æ–¹: [4, 16, 36, 64, 100]

=== 2. é—­åŒ…æ•è·ç¯å¢ƒ ===
å¤§äº 5 çš„æ•°ä¹˜ä»¥ 2: [12, 14, 16, 18, 20]

=== 3. æ¨¡æ‹Ÿæ–‡ä»¶æœç´¢ ===
Rust æºæ–‡ä»¶: ["src/main.rs", "src/lib.rs", "tests/test.rs"]

=== 4. å¸¦è¡Œå·çš„æœç´¢ç»“æœ ===
3:// TODO: add error handling
5:// TODO: refactor this

=== 5. ç»Ÿè®¡ä¿¡æ¯ ===
æ€»å­—ç¬¦æ•°: 22, æœ€é•¿å•è¯: awesome

=== 6. å±•å¹³åµŒå¥—ç»“æ„ ===
å±•å¹³å: [1, 2, 3, 4, 5, 6, 7, 8, 9]

=== 7. ripgrep é£æ ¼è¿‡æ»¤é“¾ ===
src/main.rs:10:let x = 1;
src/main.rs:20:let y = x;

=== 8. æ¡ä»¶æˆªå– ===
10 ä¹‹å‰: [1, 2, 3]
ä» 10 å¼€å§‹: [10, 11, 12, 4, 5, 6]

=== 9. è‡ªå®šä¹‰è¿­ä»£å™¨ ===
1: first line
2: second line
3: third line

=== 10. å¯å¹¶è¡ŒåŒ–çš„è¿­ä»£æ¨¡å¼ ===
1-100 å¶æ•°å¹³æ–¹å’Œ: 171700
```

---

## ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜ï¼š"Rust çš„è¿­ä»£å™¨å’Œé—­åŒ…æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿä¸å…¶ä»–è¯­è¨€ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"Rust çš„è¿­ä»£å™¨å¯ä»¥éå†é›†åˆï¼Œé—­åŒ…æ˜¯åŒ¿åå‡½æ•°ã€‚è·Ÿ JavaScript çš„ mapã€filter å·®ä¸å¤šã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **Rust çš„è¿­ä»£å™¨å’Œé—­åŒ…æœ‰ä¸‰ä¸ªç‹¬ç‰¹ä¼˜åŠ¿ï¼š**
>
> **1. é›¶æˆæœ¬æŠ½è±¡**
>
> Rust çš„è¿­ä»£å™¨é“¾åœ¨ç¼–è¯‘æ—¶ä¼šè¢«å®Œå…¨å†…è”å±•å¼€ã€‚`.filter().map().collect()` è¿™æ ·çš„é“¾å¼è°ƒç”¨ï¼Œç¼–è¯‘åçš„æœºå™¨ç å’Œæ‰‹å†™çš„ for å¾ªç¯ä¸€æ ·é«˜æ•ˆï¼Œç”šè‡³æ›´å¿«ï¼Œå› ä¸ºç¼–è¯‘å™¨æ›´å®¹æ˜“åšä¼˜åŒ–ã€‚
>
> ```rust
> // è¿™ä¸¤ç§å†™æ³•æ€§èƒ½ç›¸åŒ
> let sum: i32 = (1..1000).filter(|x| x % 2 == 0).sum();
>
> let mut sum = 0;
> for x in 1..1000 {
>     if x % 2 == 0 { sum += x; }
> }
> ```
>
> **2. æƒ°æ€§æ±‚å€¼**
>
> è¿­ä»£å™¨é€‚é…å™¨ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œåªæœ‰æ¶ˆè´¹è€…ï¼ˆå¦‚ `collect()`ï¼‰æ‰è§¦å‘è®¡ç®—ã€‚è¿™æ„å‘³ç€ï¼š
> - ä¸ä¼šåˆ›å»ºä¸­é—´é›†åˆï¼ŒèŠ‚çœå†…å­˜
> - å¯ä»¥å¤„ç†æ— é™åºåˆ—
> - çŸ­è·¯æ“ä½œï¼ˆå¦‚ `find()`ï¼‰ä¼šæå‰ç»ˆæ­¢
>
> ç›¸æ¯”ä¹‹ä¸‹ï¼ŒJavaScript çš„ `arr.filter().map()` æ¯ä¸€æ­¥éƒ½ä¼šåˆ›å»ºæ–°æ•°ç»„ã€‚
>
> **3. é—­åŒ…ä¸æ‰€æœ‰æƒç³»ç»Ÿçš„æ·±åº¦é›†æˆ**
>
> Rust çš„é—­åŒ…åˆ†ä¸ºä¸‰ç§ traitï¼š`Fn`ã€`FnMut`ã€`FnOnce`ï¼Œå¯¹åº”ä¸åŒçš„æ•è·æ–¹å¼ã€‚ç¼–è¯‘å™¨è‡ªåŠ¨æ¨æ–­æœ€å°æƒé™ï¼Œä¿è¯ï¼š
> - ä¸ä¼šæ„å¤–ä¿®æ”¹æ•è·çš„å˜é‡
> - è·¨çº¿ç¨‹ä½¿ç”¨æ—¶ç¼–è¯‘å™¨å¼ºåˆ¶æ£€æŸ¥ `Send + Sync`
> - æ²¡æœ‰ JavaScript é‚£æ ·çš„"é—­åŒ…é™·é˜±"
>
> **åœ¨ ripgrep ä¸­çš„å®é™…åº”ç”¨ï¼š**
>
> ripgrep ä½¿ç”¨è¿­ä»£å™¨æƒ°æ€§éå†ç›®å½•æ ‘ï¼ˆ`walkdir`ï¼‰ï¼Œç”¨é—­åŒ…å®šä¹‰è¿‡æ»¤æ¡ä»¶ï¼ˆ`.gitignore` è§„åˆ™ï¼‰ï¼Œæ•´ä¸ªæœç´¢ç®¡é“éƒ½æ˜¯è¿­ä»£å™¨é“¾ã€‚è¿™ç§è®¾è®¡è®© ripgrep èƒ½å¤Ÿå¤„ç†ç™¾ä¸‡çº§æ–‡ä»¶è€Œä¸ä¼šå†…å­˜æº¢å‡ºï¼ŒåŒæ—¶ä¿æŒä»£ç çš„å¯è¯»æ€§ã€‚
>
> ```rust
> // ripgrep é£æ ¼çš„æœç´¢ç®¡é“
> WalkDir::new(path)
>     .into_iter()
>     .filter_entry(|e| !is_ignored(e))  // é—­åŒ…è¿‡æ»¤
>     .filter_map(|e| e.ok())
>     .filter(|e| e.file_type().is_file())
>     .par_bridge()  // è½¬ä¸ºå¹¶è¡Œè¿­ä»£å™¨
>     .for_each(|entry| search_file(entry));
> ```

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… ä¸åªæ˜¯æè¿°åŠŸèƒ½ï¼Œè€Œæ˜¯å¯¹æ¯”å…¶ä»–è¯­è¨€è¯´æ˜ä¼˜åŠ¿
2. âœ… ç”¨å…·ä½“æ•°æ®/ä»£ç æ”¯æ’‘è§‚ç‚¹ï¼ˆé›¶æˆæœ¬ã€æƒ°æ€§æ±‚å€¼ï¼‰
3. âœ… å±•ç¤ºäº†å¯¹ Rust ç‹¬ç‰¹è®¾è®¡ï¼ˆæ‰€æœ‰æƒç³»ç»Ÿï¼‰çš„ç†è§£
4. âœ… è”ç³»å®é™…é¡¹ç›®ï¼ˆripgrepï¼‰è¯´æ˜åº”ç”¨åœºæ™¯
5. âœ… ä»£ç ç¤ºä¾‹ç®€æ´æœ‰åŠ›

---

## ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šä»€ä¹ˆæ˜¯è¿­ä»£å™¨ ğŸ¯

**ä¸€å¥è¯ï¼š** è¿­ä»£å™¨æ˜¯èƒ½é€ä¸ªäº§å‡ºå…ƒç´ çš„å¯¹è±¡ï¼Œå®ç°äº† `Iterator` traitã€‚

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```rust
trait Iterator {
    type Item;
    fn next(&mut self) -> Option<Self::Item>;
}
```

æ¯æ¬¡è°ƒç”¨ `next()` è¿”å› `Some(å€¼)` æˆ– `None`ï¼ˆè¿­ä»£ç»“æŸï¼‰ã€‚

**åº”ç”¨ï¼š** ripgrep ç”¨è¿­ä»£å™¨é€ä¸ªéå†ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œä¸éœ€è¦ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ–‡ä»¶åã€‚

---

### å¡ç‰‡2ï¼šIterator trait æ ¸å¿ƒ ğŸ“

**ä¸€å¥è¯ï¼š** `Iterator` trait åªè¦æ±‚å®ç° `next()`ï¼Œå…¶ä»– 70+ æ–¹æ³•éƒ½æœ‰é»˜è®¤å®ç°ã€‚

**ä¸¾ä¾‹ï¼š**
```rust
// åªå®ç° nextï¼Œè‡ªåŠ¨è·å¾— mapã€filterã€sum ç­‰æ–¹æ³•ï¼
impl Iterator for MyIter {
    type Item = i32;
    fn next(&mut self) -> Option<i32> { /* ... */ }
}
```

**åº”ç”¨ï¼š** ripgrep çš„ `grep-searcher` è¿”å›çš„åŒ¹é…ç»“æœå®ç° Iteratorï¼Œå¯ä»¥ç›´æ¥ç”¨ `filter`ã€`map` å¤„ç†ã€‚

---

### å¡ç‰‡3ï¼šé€‚é…å™¨ï¼šæƒ°æ€§å˜æ¢ ğŸ”„

**ä¸€å¥è¯ï¼š** é€‚é…å™¨ï¼ˆmapã€filter ç­‰ï¼‰è¿”å›æ–°è¿­ä»£å™¨ï¼Œä½†ä¸ç«‹å³æ‰§è¡Œã€‚

**ä¸¾ä¾‹ï¼š**
```rust
let iter = vec![1, 2, 3].iter()
    .map(|x| {
        println!("å¤„ç† {}", x);  // ä¸ä¼šæ‰“å°ï¼
        x * 2
    });
// æ­¤æ—¶ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿï¼Œç›´åˆ°è°ƒç”¨ collect() ç­‰æ¶ˆè´¹è€…
```

**åº”ç”¨ï¼š** ripgrep çš„è¿‡æ»¤æ¡ä»¶é“¾éƒ½æ˜¯æƒ°æ€§çš„ï¼Œé‡åˆ°ä¸€ä¸ªä¸åŒ¹é…çš„æ–‡ä»¶å°±è·³è¿‡ï¼Œä¸ä¼šå¤šåšæ— ç”¨åŠŸã€‚

---

### å¡ç‰‡4ï¼šæ¶ˆè´¹è€…ï¼šè§¦å‘è®¡ç®— âš¡

**ä¸€å¥è¯ï¼š** æ¶ˆè´¹è€…ï¼ˆcollectã€sumã€for_each ç­‰ï¼‰ä¼š"æ‹‰å–"æ•°æ®ï¼Œè§¦å‘æ•´ä¸ªè¿­ä»£å™¨é“¾æ‰§è¡Œã€‚

**å¸¸ç”¨æ¶ˆè´¹è€…ï¼š**
| æ¶ˆè´¹è€… | ä½œç”¨ |
|-------|------|
| `collect()` | æ”¶é›†åˆ°é›†åˆ |
| `sum()` | æ±‚å’Œ |
| `for_each()` | æ‰§è¡Œå‰¯ä½œç”¨ |
| `find()` | æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é… |
| `count()` | è®¡æ•° |

**åº”ç”¨ï¼š** ripgrep æœ€ç»ˆé€šè¿‡ `for_each` å°†åŒ¹é…ç»“æœè¾“å‡ºåˆ°ç»ˆç«¯ã€‚

---

### å¡ç‰‡5ï¼šé—­åŒ…åŸºç¡€è¯­æ³• ğŸ“¦

**ä¸€å¥è¯ï¼š** é—­åŒ…æ˜¯ç”¨ `|å‚æ•°| è¡¨è¾¾å¼` è¯­æ³•å®šä¹‰çš„åŒ¿åå‡½æ•°ã€‚

**è¯­æ³•å˜ä½“ï¼š**
```rust
|x, y| x + y           // æœ€ç®€å½¢å¼
|x: i32| -> i32 { x }  // å®Œæ•´å½¢å¼
|| println!("hi")      // æ— å‚æ•°
|x| { let y = x; y }   // å¤šè¯­å¥
```

**åº”ç”¨ï¼š** ripgrep çš„ `--type` è¿‡æ»¤ç”¨é—­åŒ…ï¼š`filter(|f| f.ends_with(".rs"))`

---

### å¡ç‰‡6ï¼šFn / FnMut / FnOnce ä¸‰å…„å¼Ÿ ğŸ­

**ä¸€å¥è¯ï¼š** ä¸‰ç§ trait è¡¨ç¤ºé—­åŒ…å¦‚ä½•ä½¿ç”¨æ•è·çš„å˜é‡ã€‚

| Trait | æ•è·æ–¹å¼ | å¯è°ƒç”¨æ¬¡æ•° |
|-------|---------|----------|
| `Fn` | ä¸å¯å˜å€Ÿç”¨ | æ— é™æ¬¡ |
| `FnMut` | å¯å˜å€Ÿç”¨ | æ— é™æ¬¡ |
| `FnOnce` | è·å–æ‰€æœ‰æƒ | ä¸€æ¬¡ |

**åº”ç”¨ï¼š** ripgrep çš„æœç´¢å›è°ƒæ˜¯ `FnMut`ï¼ˆå¯èƒ½æ›´æ–°è®¡æ•°å™¨ï¼‰ï¼Œè¿‡æ»¤å™¨æ˜¯ `Fn`ï¼ˆåªè¯»åˆ¤æ–­ï¼‰ã€‚

---

### å¡ç‰‡7ï¼šmove ä¸æ‰€æœ‰æƒ ğŸšš

**ä¸€å¥è¯ï¼š** `move` å…³é”®å­—å¼ºåˆ¶é—­åŒ…è·å–æ•è·å˜é‡çš„æ‰€æœ‰æƒã€‚

**å…¸å‹åœºæ™¯ï¼š**
```rust
let data = vec![1, 2, 3];
thread::spawn(move || {
    println!("{:?}", data);  // data è¢«ç§»åŠ¨åˆ°æ–°çº¿ç¨‹
});
// data åœ¨ä¸»çº¿ç¨‹å·²ä¸å¯ç”¨
```

**åº”ç”¨ï¼š** ripgrep çš„å¹¶è¡Œæœç´¢ä¸­ï¼Œé…ç½®é€šè¿‡ `Arc` + `move` ä¼ é€’ç»™å·¥ä½œçº¿ç¨‹ã€‚

---

### å¡ç‰‡8ï¼šæƒ°æ€§æ±‚å€¼åŸç† ğŸ’¤

**ä¸€å¥è¯ï¼š** è¿­ä»£å™¨æ˜¯çŠ¶æ€æœºï¼Œæ¯æ¬¡ `next()` æ‰è®¡ç®—ä¸‹ä¸€ä¸ªå€¼ã€‚

**å¯è§†åŒ–ï¼š**
```
æ•°æ®æº â†â”€â”€ filter â†â”€â”€ map â†â”€â”€ collect
                              â†“
                         "æ‹‰å–"ä¸‹ä¸€ä¸ªå€¼
```

collect å‘ map è¦å€¼ï¼Œmap å‘ filter è¦ï¼Œfilter å‘æ•°æ®æºè¦... æŒ‰éœ€è®¡ç®—ï¼

**åº”ç”¨ï¼š** æœç´¢å¤§ç›®å½•æ—¶ï¼Œripgrep ä¸ä¼šé¢„å…ˆåˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ï¼Œè€Œæ˜¯è¾¹éå†è¾¹æœç´¢ã€‚

---

### å¡ç‰‡9ï¼šripgrep ä¸­çš„è¿­ä»£å™¨æ¨¡å¼ ğŸ”

**ä¸€å¥è¯ï¼š** ripgrep çš„æ ¸å¿ƒæ˜¯"ç›®å½•éå† â†’ æ–‡ä»¶è¿‡æ»¤ â†’ å†…å®¹æœç´¢ â†’ ç»“æœè¾“å‡º"çš„è¿­ä»£å™¨ç®¡é“ã€‚

**ç®€åŒ–ç¤ºæ„ï¼š**
```rust
WalkDir::new(path)           // è¿­ä»£ç›®å½•
    .filter_entry(|e| ...)   // è¿‡æ»¤ .gitignore
    .filter_map(|e| e.ok())  // å¿½ç•¥é”™è¯¯
    .filter(|e| ...)         // æ–‡ä»¶ç±»å‹è¿‡æ»¤
    .for_each(|e| search(e)) // æœç´¢å¹¶è¾“å‡º
```

**åº”ç”¨ï¼š** è¿™ç§ç®¡é“è®¾è®¡è®© ripgrep èƒ½å¤„ç†ç™¾ä¸‡æ–‡ä»¶è€Œä¸å´©æºƒã€‚

---

### å¡ç‰‡10ï¼šæ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ ğŸš€

**ä¸€å¥è¯ï¼š** è¿­ä»£å™¨æ˜¯é›¶æˆæœ¬çš„ï¼Œä½†è¦æ³¨æ„é¿å…ä¸å¿…è¦çš„ `collect()`ã€‚

**æœ€ä½³å®è·µï¼š**
```rust
// âŒ ä¸å¥½ï¼šåˆ›å»ºäº†ä¸­é—´ Vec
let temp: Vec<_> = data.iter().filter(...).collect();
let result: Vec<_> = temp.iter().map(...).collect();

// âœ… å¥½ï¼šä¸€æ¡é“¾å®Œæˆ
let result: Vec<_> = data.iter()
    .filter(...)
    .map(...)
    .collect();
```

**åº”ç”¨ï¼š** ripgrep å…¨ç¨‹ä½¿ç”¨è¿­ä»£å™¨é“¾ï¼Œåªåœ¨æœ€ç»ˆè¾“å‡ºæ—¶æ‰"æ¶ˆè´¹"ç»“æœã€‚

---

## ã€ä¸€å¥è¯æ€»ç»“ã€‘

**è¿­ä»£å™¨æ˜¯ Rust æƒ°æ€§æ±‚å€¼çš„æ•°æ®éå†æŠ½è±¡ï¼Œé—­åŒ…æ˜¯èƒ½å¤Ÿæ•è·ç¯å¢ƒå˜é‡çš„åŒ¿åå‡½æ•°ï¼Œä¸¤è€…ç»“åˆå®ç°é›¶æˆæœ¬çš„é“¾å¼æ•°æ®å¤„ç†ï¼Œæ˜¯ ripgrep é«˜æ•ˆéå†æ–‡ä»¶ã€è¿‡æ»¤å†…å®¹ã€è¾“å‡ºç»“æœçš„æ ¸å¿ƒå·¥å…·ã€‚**

---

## å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] èƒ½è§£é‡Š `iter()`ã€`iter_mut()`ã€`into_iter()` çš„åŒºåˆ«
- [ ] èƒ½æ‰‹å†™ä¸€ä¸ªå®ç° `Iterator` trait çš„ç±»å‹
- [ ] ç†è§£æƒ°æ€§æ±‚å€¼ï¼šé€‚é…å™¨ vs æ¶ˆè´¹è€…
- [ ] èƒ½åŒºåˆ† `Fn`ã€`FnMut`ã€`FnOnce`
- [ ] ç†è§£ `move` å…³é”®å­—çš„ä½œç”¨
- [ ] èƒ½å†™å‡ºé“¾å¼è¿­ä»£å™¨å¤„ç†æ•°æ®
- [ ] ç†è§£é›¶æˆæœ¬æŠ½è±¡çš„å«ä¹‰

## ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

1. **é”™è¯¯å¤„ç†**ï¼šå­¦ä¹  `Result` å’Œ `?` è¿ç®—ç¬¦ï¼Œè¿­ä»£å™¨ä¸­çš„é”™è¯¯å¤„ç†
2. **å¹¶è¡Œè¿­ä»£å™¨**ï¼šå­¦ä¹  rayon åº“çš„ `par_iter()`
3. **è‡ªå®šä¹‰è¿­ä»£å™¨**ï¼šä¸ºè‡ªå·±çš„æ•°æ®ç»“æ„å®ç° Iterator
4. **ripgrep æºç **ï¼šé˜…è¯» `grep-searcher` ä¸­çš„è¿­ä»£å™¨ä½¿ç”¨

## å‚è€ƒèµ„æº

- [The Rust Book - Iterators](https://doc.rust-lang.org/book/ch13-02-iterators.html)
- [The Rust Book - Closures](https://doc.rust-lang.org/book/ch13-01-closures.html)
- [Iterator trait æ–‡æ¡£](https://doc.rust-lang.org/std/iter/trait.Iterator.html)
- [ripgrep æºç ](https://github.com/BurntSushi/ripgrep)
